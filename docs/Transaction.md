### 1. 트랜잭션
- 트랜잭션이란 사용자가 실행하고자하는 기능이 갖는 데이터 처리의 최소 단위. All or Nothing으로 전체 처리가 다 이루어지거나, 다 실패한다.
- 트랜잭션이 제 기능을 안전하고 완전하게 이행하도록 설정하는 것은 매우 중요하다.
- 또한 성능면에서 **정말 필요한 기능**만을 수행하게 하는 것도 매우 중요하다. 
  - 성능면에서 왜 중요하냐면,
    - 트랜잭션을 수행할 때, 한 작업이 실패할 경우, 앞에 처리한 모든 작업이 롤백되어버린다. 트랜잭션이 길수록 성능에서 손해를 본다는 의미다.
    - DB락이 걸려있을 경우, 해당 트랜잭션이 완료될 때까지 다른 트랜잭션에서 해당 DB에 접근할 수 없게 된다. 트랜잭션이 길수록, 다른 트랜잭션의 DB접근이 지체된다. 
- 그러므로 트랜잭션의 범위와 책임을 최소한(짧게)으로 가져가는 것이 중요하다.

### 2. 콘서트 예약 API의 트랜잭션
Read
- 콘서트 날짜 조회
- 콘서트 좌석 조회
- 포인트 조회
- 예약 내역 조회

CUD
- 좌석 예약
- 좌석 예약 취소
- 포인트 충전
- 결제 내역 생성
- 결제
- 결제 취소

Read 부분은 단순 조회이므로, 이미 트랜잭션의 범위와 책임이 적절히 분리되어있다.  
그럼 CUD 부분의 트랜잭션들이 어떻게 구성되어있나 살펴보고, 트랜잭션의 범위와 책임을 어떻게 하면 더 잘 분리할 수 있을지 고민해보자.

#### 2-1) 예약
1. 좌석 조회
2. 좌석 상태 업데이트
3. 예약 생성(5분동안 점유)
4. 결제 내역 생성

- 예약 트랜잭션의 책임은 좌석의 상태를 업데이트하고, 예약 객체를 생성하는 것.
- `결제 내역 생성`은 예약 트랜잭션의 책임밖이므로 따로 분리하는 게 나을 듯 하다.

#### 2-2) 예약 취소
1. 예약 조회
2. 결제 내역 조회
3. 결제 내역 존재 시 환불 처리 
4. 예약 업데이트
5. 좌석 상태 업데이트

- 예약 취소 트랜잭션의 책임은 예약 상태와 좌석 상태를 업데이트하는 것.
- `결제 내역`에 대한 업데이트는 분리할 수 있다.

#### 2-3) 포인트 업데이트(충전/사용)
1. 사용자 포인트 조회
2. 사용자 포인트 업데이트
3. 포인트 내역 생성

- 포인트 업데이트 트랜잭션의 책임은 사용자 포인트
에 대한 업데이트 처리와 그에 대한 포인트 내역(PointHistory)을 남기는 것.
- 이미 트랜잭션의 범위와 책임이 적절히 분리되어있다.

#### 2-4) 결제
1. 결제 내역 조회
2. 사용자 조회
3. 사용자 포인트 업데이트 
4. 예약 조회 
5. 예약 상태 업데이트
6. 결제 내역 업데이트

- 결제 트랜잭션의 책임은 사용자 포인트를 차감하고, 결제 내역에 대한 업데이트, 그리고 예약에 대한 업데이트 처리.
- 만약 예약이 더이상 유효하지 않거나, 포인트가 부족한 경우 결제 트랜잭션은 실패해야함
- 결제와 예약에 대한 관심사를 분리하되, 트랜잭션 실패에 대한 보상 트랜잭션 처리를 해줘야한다.

#### 2-5) 결제 취소
1. 결제내역 조회
2. 사용자 조회
3. 사용자 포인트 업데이트
4. 사용자 포인트내역 생성
5. 예약 조회
6. 예약 상태 업데이트
7. 좌석 조회
8. 좌석 상태 업데이트
9. 결제내역 업데이트

- 결제 취소 트랜잭션의 책임은 결제내역 상태를 업데이트하고, 사용자 포인트를 업데이트하는 것.
- 사용자 포인트 업데이트 부분은 외부 API(PG사)에 의존하기 때문에 분리하는 게 맞다고 생각함.